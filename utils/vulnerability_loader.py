"""
Vulnerability data loading and processing utilities.
Provides STH (Students in Temporary Housing) and ENI (Economic Need Index) as separate indicators.

Data Source: HTYPE PowerBI Export > Vulnerability_Indicators tab
(Consolidated from NYC Schools Reference Data via Apps Script)

Architecture:
- Data is pre-consolidated and normalized by Apps Script in HTYPE PowerBI Export
- This module simply loads the clean, aligned data
- All DBNs match the authoritative School Training Status list
- Percentages are already in decimal format (0.1055 = 10.55%)
"""
import pandas as pd
import numpy as np
from pathlib import Path
from typing import Optional
import logging

logger = logging.getLogger(__name__)

# Threshold for "high" designation (can be adjusted)
HIGH_STH_THRESHOLD = 0.30  # 30% STH is notably high
HIGH_ENI_THRESHOLD = 0.85  # 85% ENI is notably high

# Tab name for consolidated vulnerability data
VULNERABILITY_TAB = 'Vulnerability_Indicators'


def parse_percentage_string(value) -> Optional[float]:
    """
    Parse a percentage value that may be a string like '87.9%' or a decimal like 0.879.

    Google Sheets often returns formatted display values like '87.9%' via get_all_records().
    This function handles both raw decimals and formatted strings.

    Returns:
        Float in decimal form (0.0-1.0), or None if invalid
    """
    if pd.isna(value) or value == '' or value is None:
        return None

    # If already a number, check if it needs normalization
    if isinstance(value, (int, float)):
        num = float(value)
        # If > 1, assume it's a whole percentage (87.9 = 87.9%)
        return num / 100 if num > 1 else num

    # Handle string values
    str_val = str(value).strip()
    if not str_val:
        return None

    # Remove % sign if present
    if str_val.endswith('%'):
        str_val = str_val[:-1]

    try:
        num = float(str_val)
        # If > 1, it's a whole percentage (87.9 = 87.9%)
        return num / 100 if num > 1 else num
    except ValueError:
        return None


def load_vulnerability_data(data_dir: Optional[Path] = None) -> pd.DataFrame:
    """
    Load consolidated vulnerability data from HTYPE PowerBI Export.

    The Vulnerability_Indicators tab contains pre-consolidated, normalized data:
    - Aligned to the authoritative 1,656 school DBN list
    - Percentages may be formatted as strings ('87.9%') - will be converted to decimals
    - Includes high_sth and high_eni flags

    If the Vulnerability_Indicators tab doesn't exist or is empty, falls back to
    the legacy loader that reads from separate ENI/STH tabs in NYC Schools Reference Data.

    Returns DataFrame with:
    - school_dbn: Primary key
    - school_name: School name
    - enrollment: Student enrollment count
    - economic_need_index: ENI as decimal (0.0-1.0)
    - sth_count: Students in temporary housing count
    - sth_percent: STH percentage as decimal (0.0-1.0)
    - high_sth: Boolean flag for high STH (>=30%)
    - high_eni: Boolean flag for high ENI (>=85%)
    """
    # Import here to avoid circular imports
    from .data_loader import load_from_google_sheets, GOOGLE_SHEET_ID

    # Try to load from consolidated Vulnerability_Indicators tab first
    try:
        df = load_from_google_sheets(
            sheet_id=GOOGLE_SHEET_ID,
            sheet_name=VULNERABILITY_TAB
        )
        print(f"[VULNERABILITY] Loaded {len(df)} records from {VULNERABILITY_TAB}")
        logger.info(f"Loaded {len(df)} vulnerability records from {VULNERABILITY_TAB}")

        # If empty or missing key columns, fall back to legacy
        if len(df) == 0 or 'school_dbn' not in df.columns:
            print(f"[VULNERABILITY] Tab empty/malformed, falling back to legacy loader")
            logger.warning(f"{VULNERABILITY_TAB} tab is empty or malformed, falling back to legacy loader")
            legacy_df = _load_vulnerability_data_legacy()
            print(f"[VULNERABILITY] Legacy loader returned {len(legacy_df)} records")
            return legacy_df

    except Exception as e:
        print(f"[VULNERABILITY] Exception loading tab: {e}, falling back to legacy")
        logger.warning(f"Failed to load {VULNERABILITY_TAB}: {e}, falling back to legacy loader")
        legacy_df = _load_vulnerability_data_legacy()
        print(f"[VULNERABILITY] Legacy loader returned {len(legacy_df)} records")
        return legacy_df

    # Parse percentage columns (Google Sheets returns formatted strings like '87.9%')
    pct_cols = ['sth_percent', 'economic_need_index']
    for col in pct_cols:
        if col in df.columns:
            df[col] = df[col].apply(parse_percentage_string)
            non_null = df[col].notna().sum()
            logger.info(f"Parsed {col}: {non_null} non-null values")

    # Ensure other numeric types
    other_numeric_cols = ['enrollment', 'sth_count']
    for col in other_numeric_cols:
        if col in df.columns:
            df[col] = pd.to_numeric(df[col], errors='coerce')

    # Parse boolean columns (may be strings like 'TRUE'/'FALSE')
    bool_cols = ['high_sth', 'high_eni']
    for col in bool_cols:
        if col in df.columns:
            df[col] = df[col].apply(lambda x: str(x).upper() == 'TRUE' if pd.notna(x) else False)

    # DEBUG: Log sample values after parsing
    if 'sth_percent' in df.columns:
        sth_data = df['sth_percent'].dropna()
        if len(sth_data) > 0:
            logger.info(f"STH after parsing - count: {len(sth_data)}, max: {sth_data.max():.4f}, sample: {sth_data.head(5).tolist()}")

    return df


def _load_vulnerability_data_legacy() -> pd.DataFrame:
    """
    Legacy loader: Load vulnerability data from separate ENI/STH tabs.

    This is a fallback in case the Vulnerability_Indicators tab doesn't exist yet.
    Will be deprecated once consolidation script is deployed.
    """
    from .data_loader import load_from_google_sheets

    # Legacy configuration
    REFERENCE_SHEET_ID = "1tt-rYw5Z9iPHrJwn7YcagMcX1WvwHEWjhtPapuaUDFE"

    try:
        # Load ENI data
        eni_df = load_from_google_sheets(
            sheet_id=REFERENCE_SHEET_ID,
            sheet_name='ENI_by_School'
        )
        logger.info(f"[Legacy] Loaded {len(eni_df)} ENI records")

        # Load STH data
        sth_df = load_from_google_sheets(
            sheet_id=REFERENCE_SHEET_ID,
            sheet_name='STH_by_School'
        )
        logger.info(f"[Legacy] Loaded {len(sth_df)} STH records")

        # Merge ENI and STH data on school_dbn
        df = pd.merge(
            eni_df[['school_dbn', 'economic_need_index']],
            sth_df[['school_dbn', 'sth_count', 'sth_percent']],
            on='school_dbn',
            how='outer'
        )

        # Ensure numeric types
        df['economic_need_index'] = pd.to_numeric(df['economic_need_index'], errors='coerce')
        df['sth_percent'] = pd.to_numeric(df['sth_percent'], errors='coerce')
        df['sth_count'] = pd.to_numeric(df['sth_count'], errors='coerce')

        # Normalize percentages (legacy data is in whole percentage format)
        sth_max = df['sth_percent'].dropna().max() if len(df['sth_percent'].dropna()) > 0 else 0
        eni_max = df['economic_need_index'].dropna().max() if len(df['economic_need_index'].dropna()) > 0 else 0

        if sth_max > 1:
            df['sth_percent'] = df['sth_percent'] / 100
        if eni_max > 1:
            df['economic_need_index'] = df['economic_need_index'] / 100

        logger.info(f"[Legacy] Merged vulnerability data: {len(df)} schools")
        return df

    except Exception as e:
        logger.warning(f"[Legacy] Failed to load vulnerability data: {e}")
        return pd.DataFrame(columns=[
            'school_dbn', 'sth_count', 'sth_percent', 'economic_need_index'
        ])


def merge_vulnerability_with_training(
    training_df: pd.DataFrame,
    vulnerability_df: pd.DataFrame
) -> pd.DataFrame:
    """
    Merge vulnerability data with training status data.

    Args:
        training_df: School training status DataFrame (must have 'school_dbn')
        vulnerability_df: Vulnerability data DataFrame

    Returns:
        Merged DataFrame with STH and ENI columns added
    """
    # Select columns to merge
    merge_cols = ['school_dbn']
    optional_cols = ['sth_percent', 'sth_count', 'economic_need_index', 'enrollment']
    for col in optional_cols:
        if col in vulnerability_df.columns:
            merge_cols.append(col)

    merged = pd.merge(
        training_df,
        vulnerability_df[merge_cols],
        on='school_dbn',
        how='left'
    )

    # Add flag columns for high STH and high ENI (if not already present)
    if 'sth_percent' in merged.columns and 'high_sth' not in merged.columns:
        merged['high_sth'] = merged['sth_percent'] >= HIGH_STH_THRESHOLD

    if 'economic_need_index' in merged.columns and 'high_eni' not in merged.columns:
        merged['high_eni'] = merged['economic_need_index'] >= HIGH_ENI_THRESHOLD

    return merged


def calculate_vulnerability_stats(df: pd.DataFrame) -> dict:
    """
    Calculate summary statistics for vulnerability indicators.

    Args:
        df: DataFrame with vulnerability columns

    Returns:
        Dictionary of statistics
    """
    stats = {
        'total_schools': len(df),
    }

    # STH statistics
    if 'sth_percent' in df.columns:
        sth_data = df['sth_percent'].dropna()
        stats['schools_with_sth_data'] = len(sth_data)
        stats['avg_sth_percent'] = sth_data.mean() if len(sth_data) > 0 else None
        stats['max_sth_percent'] = sth_data.max() if len(sth_data) > 0 else None
        stats['high_sth_count'] = (df['sth_percent'] >= HIGH_STH_THRESHOLD).sum()

    # ENI statistics
    if 'economic_need_index' in df.columns:
        eni_data = df['economic_need_index'].dropna()
        stats['schools_with_eni_data'] = len(eni_data)
        stats['avg_eni'] = eni_data.mean() if len(eni_data) > 0 else None
        stats['max_eni'] = eni_data.max() if len(eni_data) > 0 else None
        stats['high_eni_count'] = (df['economic_need_index'] >= HIGH_ENI_THRESHOLD).sum()

    return stats


def get_sth_color(sth_percent: Optional[float]) -> list:
    """
    Get color for STH percentage visualization.
    Gradient from green (low) to red (high STH).

    Returns RGBA color as list [R, G, B, A].
    """
    if sth_percent is None or pd.isna(sth_percent):
        return [128, 128, 128, 150]  # Gray for unknown

    # Clamp to 0-1
    sth = max(0, min(1, sth_percent))

    # Color gradient based on STH severity
    if sth < 0.10:
        return [100, 160, 120, 180]  # Low - sage green
    elif sth < 0.20:
        return [180, 180, 100, 180]  # Moderate - yellow
    elif sth < 0.30:
        return [200, 150, 80, 180]   # Elevated - amber
    else:
        return [180, 100, 100, 180]  # High - coral/red


def get_sth_tier(sth_percent: Optional[float]) -> str:
    """Categorize STH percentage into tiers."""
    if sth_percent is None or pd.isna(sth_percent):
        return "Unknown"
    if sth_percent >= 0.30:
        return "High (30%+)"
    elif sth_percent >= 0.20:
        return "Elevated (20-30%)"
    elif sth_percent >= 0.10:
        return "Moderate (10-20%)"
    else:
        return "Low (<10%)"
